# 환율 예측 모델

## 목차

1. 환율 예측 개요
2. 환율에 영향을 미치는 요인
3. 환율 예측 시 사용 가능 모델 및 분석
4. 사용 모델
5. GPU 서버 설정
6. 로직 설명
7. 결과값

## 1. 환율 예측 개요

- 환율은 상당히 많은 요소들을 고려해서 그 날의 환율이 정해짐. 그렇기에 정확하게 환율을 예측하는 것은 무리가 있고, 어느정도의 오차 범위를 두고 계산을 함.
- 사용자에게 희망 환율 설정시에 환율과 관련된 참고용 자료를 주기 위함
- 흔히 사용되는 USD, JPY에서 환율 예측을 사용함

## 2. 환율에 영향을 미치는 요인?

- 환율에 영향을 미치는 요인은 매우 다양하며, 경제적, 정치적, 사회적, 심리적 요소들이 복합적으로 작용 됨. 주요 요인은 다음과 같음

1. 국가별 금리(국채 금리 정보)
2. 국가별 주식시장 지표(S&P 500, KOSPI, NASDAQ, NIKKEI, DAX, TAIEX)
3. 상품 가격(WTI Crude Oil, Gold, Copper)
4. 기업 실적 및 재무 데이터
5. GDP 성장률
6. 무역 수지
7. 국채 수익률 곡선(10-Year-Treasury Yield)
8. 통화 관련 ETF(UUP, FXE)

### 학습 시킬 데이터 기간?

- 2009년 - 2019년 사이 데이터 : 2008년의 금융 위기가 끝난 이후 - 코로나19 사태 이전의 데이터는 비교적 안정적인 흐름을 보여줘서 급격한 변동을 학습시키기에 부적절한 데이터
- 2019년 - 현재 : 코로나19 팬데믹이나 국제 분쟁과 같은 환율에 큰 영향을 미친 기간을 데이터에 포함하는 것은 모델의 예측 성능을 높이는 데 도움이 됨. 이러한 이벤트가 만들어낸 급격한 변동성은 모델이 학습해야 할 중요한 패턴을 제공하며, 향후 비슷한 경제적 충격이 발생할 때 더 정확한 예측을 가능하게 함

### 그래서 사용한 요인은?

- 2019년 1월 1일 - 현재까지의 환율 데이터를 이용하여 SARIMAX 시계열 분석 모델을 이용하여 예측 값 분석
- 사용 데이터 :
  - yfinance에서 제공하는 해당일의 ['High'] + ['Low']의 합의 1/2 값을 평균 환율 데이터로 잡아 학습에 이용함
  - 외생변수로 yfinacne에서 제공하는 미국 10년물 국채 금리, S&P 500 지수, WTI 원유 가격, 금 가격, UUP(미국 달러 상승을 추적하는 ETF), 코스피, 나스닥, 니케이를 활용
- 다양한 시계열 분석 모델(LSTM, ARIMA, SARIMA, SARIMAX) 등의 비교를 통해

- 참고 자료 : 딥러닝을 활용한 원화 환율 예측: 시장 및 웹데이터와 거시경제 지표의 활용, 전문기관의 원/달러 환율예측력 분석 : 시계열 모형 및 기계학습 LSTM 모형과의 비교연구

### 예측 기간은 얼마나 주면 좋을까?

- 2주, 1달, 3달, 6달 등 환율 예측 값을 제공해주는 것을 고려
- 각 기간에 대해 학습한 결과의 정확도를 2019년 1월 - 2023년 12월까지의 데이터를 학습 시킨 후 2024년 1월을 기준으로 2주, 1달, 3달, 6달을 예측하라고 시킨 후, 실제 24년도 환율과 유사한 정도를 비교

## 3. 환율 예측시 사용 가능한 데이터 및 모델 비교

### A. 2009 - 2019 vs 2019 - 현재 환율 데이터

- 2009 - 2019년 데이터와 2019 - 현재 환율 데이터를 학습시켜 실제 올해의 1월 - 6월까지의 환율과 비교하여 얼마나 잘 예측하는지 실행

![image1](/uploads/91c5e6bd27e4110606aec2f02effa41a/image1.png)

MAE(Mean Absolute Error): 평균절대오차

- 모델의 예측 값과 실제 값의 차이를 모두 더하는 개념, 낮을수록 더 좋은 값
  RMSE(Root Mean Squared Error): 평균오차
- MSE(평균제곱오차)를 구한 값에 루트를 씌워서 실제 값과 유사한 단위로 변환하여 해석을 쉽게 함, 낮을수록 더 좋은 값
  MAPE(Mean Absolute Percentage Error): 평균 절대 백분오차 비율
- MAE를 퍼센트로 변환한 값, 낮을 수록 더 좋은 값

#### ∴ 2009년 - 2019년의 데이터보다 2019년 - 현재까지의 데이터가 좀 더 높은 정확도를 보여줌

### B. 시계열 분석 모델 비교

#### 시계열 분석 모델이란?

- 시간이 흐름에 따라 변화하는 데이터를 분석하고 예측하는 데 사용되는 통계적, 기계 학습 기반의 모델
- 대표적으로 금융 데이터, 기후 데이터, 웹 사이트 방문자 수, 일일 판매량 등 시간의 흐름에 따라 변화하는 값들에 주로 사용 됨

#### 대표적으로 사용 되는 시계열 모델 종류

- LSTM: RNN의 한 종류로, 시계열 데이터를 처리하고 예측하는데 주로 사용되는 딥러닝 모델
- ARIMA: 시계열 데이터를 다루는 전통적인 통계 모델로, 자기 회귀와 이동평균의 결합을 기반으로 함. 차분을 통해 안정화시킬 수 있고 현재 데이터를 과거 데이터와 오차의 선형 결합으로 설명함
- SARIMA: 계절성을 고려한 ARIMA 모델로, 주기적으로 반복되는 패턴이 있는 시계열 데이터를 분석할때 활용
- SARIMAX: 외생변수를 추가한 SARIMA의 확장 모델로 환율, 주식 가격, 유가와 같은 시계열 데이터를 분석할 때 데이터에 영향을 줄 수 있는 외부 변수를 함께 고려하여 예측이 가능

#### LSTM, ARIMA, SARIMA, SARIMAX 모델 중 예측도가 좋은 모델 및 외생 변수 활용 가능 모델 선택

![image2](/uploads/6276814ef64cdd91972dcb8292b492dd/image2.png)
![image3](/uploads/4790f285ae5060cab74619914f625620/image3.png)

- LSTM이 현저히 낮은 결과를 보여주면서, SARIMA와 ARIMA가 유사한 결과를 보여줌
  ∴ SARIMA에서 외생변수를 추가할 수 있는 SARIMAX를 사용

### C. 예측 기간은 얼마로 줘야할지?

#### 어느 정도의 기간을 예측치로 줘야 정확하게 줄 수 있을지 모델 학습 테스트

![image4](/uploads/9ec944bf470f4319c73b91db830eae16/image4.png)

- 예측 기간이 길어질수록 정확도가 떨어지는 것을 볼 수 있음
  ∴ 2주의 예측 기간을 주는 것이 가장 적절하다고 판단

## 4. 사용 모델

### SARIMAX모델을 활용하여 기본 환율 정보 + 외생변수 데이터 활용

## 5. GPU 서버에서 진행

- # GPU 설정

  오버플로우 방지용

  ```python
  import os

  os.environ["CUDA_DEVICE_ORDER"]="PCI_BUS_ID"

  os.environ["CUDA_VISIBLE_DEVICES"]="2"
  ```

### 환율 예측 플로우

1. GPU 서버에서 지난 4년 간의 환율 데이터를 통해 SARIMA 모델을 통해 학습 시킨 후 오늘 날짜로부터 약 2주간의 예측 데이터를 글로벌 변수에 저장

2. 해당 데이터를 FastAPI의 get 요청을 통해 글로벌 변수의 예측 데이터를 얻음

3. 오전 02:00시가 되면 자동으로 환율 예측 결과를 업데이트하는 스케줄러 사용

4. 이후 백엔드로 결과값을 저장하는 요청을 보냄

## 6. 로직 설명

### 로킹 설정 이유?

- 디버깅 및 문제 해결:

  - 애플리케이션 실행 중 발생하는 오류나 예외를 기록할 수 있습니다

  - 예: 데이터베이스 연결 실패, API 호출 오류 등을 로그에 기록하여 나중에 분석할 수 있음

- 성능 모니터링:

  - 애플리케이션의 주요 작업 수행 시간을 기록하여 성능 병목 현상을 파악할 수 있음
  - 예: API 요청 처리 시간, 데이터베이스 쿼리 실행 시간 등을 로그에 기록

- 사용자 행동 분석:

  - 사용자의 액션과 이벤트를 기록하여 사용 패턴을 분석할 수 있음
  - 예: 로그인 시도, 특정 기능 사용 횟수 등을 추적할 수 있음

- 보안 감사:

  - 보안 관련 이벤트를 기록하여 잠재적인 보안 위협을 감지하고 분석할 수 있음
  - 예: 실패한 로그인 시도, 권한 변경 등을 로그에 기록

- 규정 준수:

  - 일부 산업 분야에서는 법규나 규정에 따라 특정 정보를 로깅하고 보관해야 함
  - 예: 금융 거래 기록, 개인정보 접근 로그 등을 유지해야 할 수 있음

- 애플리케이션 상태 추적:

  - 애플리케이션의 현재 상태와 진행 상황을 실시간으로 모니터링할 수 있음
  - 예: 서버 시작/종료, 주요 프로세스의 시작과 완료 등을 기록

- 개발 및 운영 효율성 향상:

  - 개발자와 운영팀이 애플리케이션의 동작을 더 잘 이해하고 관리할 수 있게 함
  - 예: 복잡한 비즈니스 로직의 실행 과정을 단계별로 로깅하여 추적할 수 있음

- 사용자 지원:

  - 사용자가 문제를 보고할 때, 관련 로그를 참조하여 더 빠르고 효과적으로 지원할 수 있음
  - 예: 사용자의 특정 액션에 대한 상세 로그를 확인하여 문제의 원인을 파악할 수 있음

### SARIMA 모델 사용 이점

- 계절성 처리:
  - SARIMA는 데이터의 계절적 패턴을 명시적으로 모델링할 수 있음
  - 예: 월별 판매 데이터에서 매년 반복되는 패턴(예: 연말 판매 증가)을 캡처할 수 있음
- 트렌드와 계절성 분리:
  - 데이터의 장기적 트렌드와 계절적 변동을 분리하여 분석할 수 있음
  - 이를 통해 각 구성 요소의 영향을 개별적으로 이해하고 예측할 수 있음
- 시계열 데이터의 비정상성 처리:
  - 차분(Differencing)을 통해 비정상 시계열을 정상 시계열로 변환할 수 있음
  - 이는 더 정확한 예측을 가능하게 함
- 자기회귀와 이동평균 결합:
  - AR(자기회귀)와 MA(이동평균) 요소를 결합하여 복잡한 시계열 패턴을 모델링함
  - 이를 통해 다양한 유형의 시계열 데이터에 적용할 수 있음
- 단기 및 중기 예측에 효과적:
  - 특히 계절성이 있는 경제, 금융, 기상 데이터 등의 예측에 유용함
- 모델 해석 용이성:
  - SARIMA 모델의 매개변수는 직관적으로 해석할 수 있어, 시계열의 특성을 이해하는 데 도움이 됨
- 자동화된 모델 선택:
  - auto_arima와 같은 도구를 사용하여 최적의 SARIMA 모델 매개변수를 자동으로 선택 가능
- 예측 불확실성 추정:
  - 예측 구간을 제공하여 예측의 불확실성을 정량화할 수 있음

### FastAPI 선택 이유?

- 빠른 성능:
  - Starlette 프레임워크를 기반으로 하여 매우 높은 성능을 제공
  - 비동기 프로그래밍을 지원하여 동시성 처리가 뛰어남
  - 벤치마크 테스트에서 Node.js와 Go에 필적하는 성능을 보임
- 쉽고 빠른 개발:
  - 직관적이고 간결한 문법으로 API를 빠르게 개발할 수 있음
  - 타입 힌트를 활용하여 코드의 가독성과 유지보수성이 향상됨
- 자동 문서화:
  - Swagger UI와 ReDoc을 통한 대화형 API 문서를 자동으로 생성함
  - 이는 개발자 간 협업과 API 사용자를 위한 문서화에 매우 유용함
- 데이터 검증:
  - Pydantic 모델을 사용하여 강력한 데이터 검증과 직렬화를 제공함
  - 이는 타입 안정성을 높이고 런타임 오류를 줄이는 데 도움이 됨
- 보안 기능:
  - OAuth2, JWT 토큰 등 다양한 보안 기능을 기본적으로 지원함
  - HTTPS, CORS 등의 웹 보안 기능도 쉽게 구현할 수 있음
- 비동기 지원:
  - 비동기 프로그래밍을 완벽히 지원하여 I/O 바운드 작업의 성능을 크게 향상시킴
- 표준 준수:
  - OpenAPI(이전의 Swagger)와 JSON Schema 표준을 완벽히 준수함
  - 이는 다른 도구와의 호환성을 높임
- 의존성 주입:
  - 강력한 의존성 주입 시스템을 제공하여 코드의 모듈화와 테스트 용이성을 높임
- 웹소켓 지원:
  - WebSocket을 지원하여 실시간 양방향 통신 애플리케이션을 쉽게 개발할 수 있음
- 테스트 용이성:
  - TestClient를 제공하여 API 엔드포인트의 단위 테스트를 쉽게 작성할 수 있음

## 결과

### 환율 예측 및 3개월 간 최근 환율

![image5](/uploads/b199e65534b4cee46a6de51a118c0459/image5.png)
![image6](/uploads/2fd7552f45ed7b0eac2c5cba36f59af5/image6.png)
![image7](/uploads/ae8e4b440d1462cfa78434c276c3065c/image7.png)
![image8](/uploads/458da03ca784e18f39fd0ab4be5975fd/image8.png)

## 사용자에게 적절한 선택지를 제공하기 위한 다양한 정보 제공

![image9](/uploads/e831f16c61780e2f14a54d26a88cc199/image9.png)
![image10](/uploads/66678b665d6bccb501a568fc7b97c7e0/image10.png)
